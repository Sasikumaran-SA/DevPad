{% extends "base.html" %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-8 max-w-4xl mx-auto" 
     id="submission-container" 
     data-submission-id="{{ submission.id }}"
     data-status-url="{{ url_for('main.get_submission_status', submission_id=submission.id) }}">

    <div class="flex justify-between items-center mb-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Submission for: {{ submission.problem.title }}</h1>
            <p class="text-sm text-gray-500">Submitted by: {{ submission.student.name }} on {{ submission.timestamp.strftime('%Y-%m-%d %H:%M') }}</p>
        </div>
        <a href="{{ url_for('main.view_problem', problem_id=submission.problem_id) }}" class="text-blue-600 hover:text-blue-800">
            &larr; Back to Problem
        </a>
    </div>

    <!-- Status Badge -->
    <div class="mb-6">
        <label class="block text-sm font-medium text-gray-500 mb-1">Status</label>
        {% if submission.status == 'Passed' %}
            <span id="status-badge" class="px-4 py-2 rounded-full text-lg font-bold bg-green-100 text-green-800">
                {{ submission.status }}
            </span>
        {% elif submission.status == 'Failed' %}
            <span id="status-badge" class="px-4 py-2 rounded-full text-lg font-bold bg-red-100 text-red-800">
                {{ submission.status }}
            </span>
        {% else %}
            <span id="status-badge" class="px-4 py-2 rounded-full text-lg font-bold bg-yellow-100 text-yellow-800 animate-pulse">
                {{ submission.status }}
            </span>
        {% endif %}
    </div>
    
    <hr class="my-6">

    <!-- Output -->
    <div class="mb-6">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Execution Output</h2>
        <pre id="output-box" class="bg-gray-900 text-white p-4 rounded-md font-mono text-sm whitespace-pre-wrap min-h-[100px]">{{ submission.output or 'Waiting for results...' }}</pre>
    </div>

    <!-- Submitted Code -->
    <div>
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Submitted Code ({{ submission.language }})</h2>
        <pre class="bg-gray-100 p-4 rounded-md font-mono text-sm whitespace-pre-wrap">{{ submission.code }}</pre>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('submission-container');
        const statusUrl = container.dataset.statusUrl;
        const statusBadge = document.getElementById('status-badge');
        const outputBox = document.getElementById('output-box');

        // Only poll if the status is 'Pending' or 'Running'
        if (statusBadge.textContent.trim() === 'Pending' || statusBadge.textContent.trim() === 'Running') {
            
            const pollInterval = setInterval(pollStatus, 3000); // Poll every 3 seconds

            function pollStatus() {
                fetch(statusUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status !== 'Pending' && data.status !== 'Running') {
                            // Stop polling
                            clearInterval(pollInterval);
                            updatePage(data);
                        } else {
                            // Still running
                            statusBadge.textContent = data.status;
                        }
                    })
                    .catch(error => {
                        console.error('Error polling status:', error);
                        clearInterval(pollInterval);
                    });
            }

            function updatePage(data) {
                statusBadge.textContent = data.status;
                statusBadge.classList.remove('bg-yellow-100', 'text-yellow-800', 'animate-pulse');

                if (data.status === 'Passed') {
                    statusBadge.classList.add('bg-green-100', 'text-green-800');
                } else {
                    statusBadge.classList.add('bg-red-100', 'text-red-800');
                }

                outputBox.textContent = data.output;
            }
        }
    });
</script>
{% endblock %}
